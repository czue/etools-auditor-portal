<!--import [polymer, lodash]-->

<script>
    'use strict';

    window.APBehaviors = window.APBehaviors || {};
    APBehaviors.EngagementBehaviorImpl = {
        properties: {
            tabsList: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            engagementPrefix: {
                type: String,
                value: ''
            }
        },

        ready: function() {
            this.engagementFileTypes = this.getData('engagement_attachments_types');
            this.reportFileTypes = this.getData('report_attachments_types');
        },

        _routeConfig: function(route) {
            if (this.route && !~this.route.prefix.indexOf(this.engagementPrefix)) { return; }

            let id = this.routeData ? this.routeData.id : route.path.split('/')[1];
            if (id && !isNaN(+id)) {
                this.engagementId = +id;
            } else {
                this.fire('404');
            }
        },

        _infoLoaded: function() {
            let tab = this.routeData ? this.routeData.tab : this.route.path.split('/')[2];
            if (!~this.tabsList.indexOf(tab)) {
                this.routeData.tab = this.tabsList[0] || '';
                return;
            }

            this.tab = tab;
        },

        _tabChanged: function(tab) {
            if (tab && this.routeData && this.routeData.tab !== tab) {
                this.set('routeData.tab', tab);
            }
        },

        _setPermissionBase: function(id) {
            if ( (!id && id !== 0 )|| isNaN(+id)) {
                this.permissionBase = null;
            } else {
                this.permissionBase = `engagement_${id}`;
            }
        },

        _saveProgress: function() {
            if (!this._validateBasicInfo()) { return; }
            if (this.customBasicValidation && !this.customBasicValidation()) { return; }

            return this._prepareData()
                    .then((data) => {
                        this.updatedEngagement = data;
                    });
        },

        _submitReport: function() {
            if (!this._validateEngagement()) { return; }

            return this._prepareData(true)
                    .then((data) => {
                        this.updatedEngagement = data;
                    });
        },

        _finalizeReport: function() {
            if (!this._validateEngagement()) { return; }

            return this._prepareData(false, true)
                    .then((data) => {
                        this.updatedEngagement = data;
                    });
        },

        _prepareData: function(submit, finalize) {
            let engagementAttachmentsTab = this.getElement('#engagement_attachments'),
                reportAttachmentsTab = this.getElement('#report_attachments');

            if (!this.engagement || !engagementAttachmentsTab || !reportAttachmentsTab) {
                return Promise.reject('You need engagement object and attachments tabs');
            }

            let data = _.clone(this.engagement);

            data.partner = data.partner.id;
            data.agreement = data.agreement.id;

            let type;
            switch (data.type) {
                case 'ma':
                    type = 'micro-assessments';
                    break;
                case 'sc':
                    type = 'spot-checks';
                    break;
                case 'audit':
                    type = 'audits';
                    break;
                default:
                    type = data.type.link;
                    data.type = data.type.value;
            }
            if (this.customDataPrepare) {
                data = this.customDataPrepare(data);
            }

            let promises = [
                engagementAttachmentsTab.getFiles(),
                reportAttachmentsTab.getFiles()
            ];

            return Promise.all(promises)
                    .then((uploadedFiles) => {
                        data.engagement_attachments = uploadedFiles[0];
                        data.report_attachments = uploadedFiles[1];
                        return {
                            type: type,
                            id: data.id,
                            data: data,
                            submit: submit ? 'submit/' : null,
                            finalize: finalize ? 'finalize/' : null
                        };
                    });
        },


        _validateBasicInfo: function(property) {
            let detailsValid = this.getElement('#engagementDetails').validate(),
                    //TODO: don't validate staff members in tabular view
                    //staffMembersValid = this.getElement('#staffMembers').validate(),
                engagementAttachmentsValid = this.getElement('#engagement_attachments').validate(),
                reportAttachmentsValid = this.getElement('#report_attachments').validate();

            if (/*!staffMembersValid || */!detailsValid || !engagementAttachmentsValid || !reportAttachmentsValid) {
                let openTab = (/*staffMembersValid && */detailsValid) ? 'attachments' : 'overview';

                this.set(property || 'tab', openTab);
                this.fire('toast', {text: 'Fix invalid fields before saving'});
                return false;
            }

            let assignReportTab = this.getElement('#assignEngagement');
            if (assignReportTab && !assignReportTab.validate('forSave')) {
                this.set(property || 'tab', 'report');
                this.fire('toast', {text: 'Fix invalid fields before saving'});
                return false;
            }

            return true;
        },

        _getMembersLength: function(length) {
            if (isNaN(+length)) { length = 0; }
            return +length || 0;
        },

        getElement: function(selector) {
            return Polymer.dom(this.root).querySelector(selector);
        },

        _configButtonsData: function() {
            if (!this.engagement) { return; }
            if (this.engagement.status === 'report_submitted') {
                this.otherActions = [];
                this.mainBtnText = 'Finalize';
            } else {
                this.otherActions = [{name: 'save', event: 'save-progress'}];
                this.mainBtnText = 'Submit';
            }
        },

        _mainActionActivated: function() {
            if (!this.engagement) { return; }
            if (this.engagement.status === 'report_submitted') {
                this._finalizeReport();
            } else {
                this._submitReport();
            }
        },

        _attachmentsReadonly: function(base, type) {
            let readOnly = this.isReadonly(`${base}.${type}`);
            if (readOnly === null) { readOnly = true; }
            return readOnly;
        }

    };

    APBehaviors.EngagementBehavior = [
        APBehaviors.EngagementBehaviorImpl,
        APBehaviors.PermissionController,
        APBehaviors.StaticDataController
    ];

</script>